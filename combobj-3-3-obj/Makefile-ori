subject=antlr
subject_dir=/home/tanghao/data/$(subject)
ori_facts=$(subject_dir)/facts
ori_db=$(subject_dir)/ori_db
replace_file=$(ori_db)/replace.csv
new_facts=$(subject_dir)/newfacts
new_db=$(subject_dir)/new_db
analysis=3o3h
analysis_noout=$(analysis)_noout
$(analysis): $(analysis).dl
	date
	souffle -c -o $(analysis) $(analysis).dl -p $(analysis).log >/dev/null 2>&1
	date
run: $(analysis)
	date
	if [ ! -d $(ori_db) ]; then mkdir $(ori_db); fi
	./$(analysis) -j8 -F$(ori_facts) -D$(ori_db)
	wc -l $(ori_db)/*.csv
	date
$(analysis_noout): $(analysis_noout).dl
	date
	souffle -c -o $(analysis_noout) $(analysis_noout).dl -p $(analysis_noout).log >/dev/null 2>&1
	date
run_noout: $(analysis_noout) 
	date
	if [ ! -d $(new_db) ]; then mkdir $(new_db); fi
	./$(analysis_noout) -j8 -F$(new_facts) -D$(new_db)
	date
findeqv: findeqv.cpp
	g++ -std=c++11 -o findeqv findeqv.cpp
run_findeqv: findeqv
	date 2>&1 | tee findeqv.log
	./findeqv $(ori_db)/VarPointsTo.csv $(ori_db)/UnfoldedHContext.csv $(ori_db)/UnfoldedContext.csv $(replace_file) 2>&1 | tee -a findeqv.log
	date 2>&1 | tee -a findeqv.log
applyreplace: applyreplace.cpp
	g++ -std=c++11 -o applyreplace applyreplace.cpp
run_applyreplace: applyreplace
	if [ ! -d $(new_facts) ]; then mkdir $(new_facts); fi
	./applyreplace $(ori_facts) $(new_facts) $(replace_file)
ls_uf:
	wc -l $(ori_db)/UnfoldedHContext.csv
	wc -l $(ori_db)/UnfoldedContext.csv
ls_old_db:
	wc -l $(ori_db)/*.csv
ls_new_db:
	wc -l $(new_db)/*.csv
clean_ori_db:
	rm -r $(ori_db)
clean_analysis:
	rm $(analysis) $(analysis).log $(analysis).cpp *.ccerr
clean_findeqv:
	rm findeqv findeqv.log	
clean_applyreplace:
	rm applyreplace
clean_all: clean_ori_db clean_analysis clean_findeqv
